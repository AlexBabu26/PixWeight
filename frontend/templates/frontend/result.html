{% extends "frontend/base.html" %}
{% load static %}
{% block title %}Result | PixWeight{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-9">
    <div class="card fade-in">
      <div class="card-body p-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-start gap-3 flex-wrap">
          <div>
            <div class="d-flex align-items-center gap-2 mb-2">
              <div class="d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); border-radius: 10px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              </div>
              <h1 class="h4 fw-bold mb-0">Weight Estimate</h1>
            </div>
            <div class="text-muted" id="objectMeta">
              <svg class="me-1" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                <line x1="7" y1="7" x2="7.01" y2="7"></line>
              </svg>
              Loading...
            </div>
          </div>
          <div class="d-flex gap-2 flex-wrap">
            <a class="btn btn-outline-primary btn-sm" id="btnQuestions" href="#">
              <svg class="me-1" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
              Edit Answers
            </a>
            <a class="btn btn-outline-secondary btn-sm" href="/history/">
              <svg class="me-1" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              History
            </a>
          </div>
        </div>

        <div class="divider"></div>

        <!-- Progress indicator - completed -->
        <div class="mb-4">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <span class="small fw-semibold" style="color: #16a34a;">
              <svg class="me-1" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Complete!
            </span>
            <span class="small text-muted">Estimation finished</span>
          </div>
          <div class="progress" style="height: 6px; border-radius: 3px;">
            <div class="progress-bar" role="progressbar" style="width: 100%; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
        </div>

        <div class="alert alert-danger d-none" id="errorBox"></div>
        <div class="alert alert-info d-none" id="infoBox"></div>

        <!-- Result Display -->
        <div id="resultBox" class="d-none">
          <!-- Main Result Card -->
          <div class="result-card mb-4">
            <div class="result-label mb-2">Estimated Weight</div>
            <div class="result-value" id="estValue">--</div>
          </div>
          
          <!-- Metrics Row -->
          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <div class="metric-card">
                <svg class="mb-2" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--primary-color)" stroke-width="2">
                  <line x1="17" y1="10" x2="3" y2="10"></line>
                  <line x1="21" y1="6" x2="3" y2="6"></line>
                  <line x1="21" y1="14" x2="3" y2="14"></line>
                  <line x1="17" y1="18" x2="3" y2="18"></line>
                </svg>
                <div class="metric-label">Weight Range</div>
                <div class="metric-value" id="estRange">--</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="metric-card">
                <svg class="mb-2" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#11998e" stroke-width="2">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                  <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                <div class="metric-label">Confidence Level</div>
                <div class="metric-value" id="estConfidence">--</div>
                <div class="confidence-meter">
                  <div class="confidence-fill" id="confidenceFill" style="width: 0%;"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Rationale Section -->
          <div class="card" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.03) 0%, rgba(118, 75, 162, 0.03) 100%); border: 1px solid rgba(102, 126, 234, 0.1);">
            <div class="card-body p-4">
              <h2 class="h6 fw-bold mb-3">
                <svg class="me-2" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--primary-color)" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="16" x2="12" y2="12"></line>
                  <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
                How We Calculated This
              </h2>
              <p class="text-muted mb-0" id="estRationale">Loading rationale...</p>
            </div>
          </div>
        </div>

        <!-- Loading State -->
        <div class="text-center py-5" id="loading">
          <div class="spinner-border mb-3" style="width: 3rem; height: 3rem; color: var(--primary-color);" role="status"></div>
          <p class="text-muted mb-0">Loading your results...</p>
        </div>

        <div class="divider"></div>

        <!-- Action Buttons -->
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
          <a href="/dashboard/" class="btn btn-primary">
            <svg class="me-2" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            New Estimation
          </a>
          
          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" onclick="window.print();">
              <svg class="me-1" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 6 2 18 2 18 9"></polyline>
                <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                <rect x="6" y="14" width="12" height="8"></rect>
              </svg>
              Print
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Feedback Form Card -->
    <div class="card mt-4 fade-in" id="feedbackCard" style="animation-delay: 0.1s; background: linear-gradient(135deg, rgba(168, 85, 247, 0.05) 0%, rgba(236, 72, 153, 0.05) 100%); border: 1px solid rgba(168, 85, 247, 0.15);">
      <div class="card-body p-4">
        <h2 class="h6 fw-bold mb-3">
          <svg class="me-2" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--primary-color)" stroke-width="2">
            <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path>
          </svg>
          Was this accurate?
        </h2>
        <p class="small text-muted mb-3">Help us improve by providing the actual weight</p>
        
        <div id="feedbackForm">
          <div class="mb-3">
            <label for="actualWeight" class="form-label small">Actual Weight (in grams)</label>
            <input type="number" class="form-control" id="actualWeight" placeholder="e.g., 500" min="0" step="0.1" required>
          </div>
          
          <div class="mb-3">
            <label class="form-label small">Accuracy Rating (optional)</label>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-sm btn-outline-secondary rating-btn" data-rating="1">1⭐</button>
              <button type="button" class="btn btn-sm btn-outline-secondary rating-btn" data-rating="2">2⭐</button>
              <button type="button" class="btn btn-sm btn-outline-secondary rating-btn" data-rating="3">3⭐</button>
              <button type="button" class="btn btn-sm btn-outline-secondary rating-btn" data-rating="4">4⭐</button>
              <button type="button" class="btn btn-sm btn-outline-secondary rating-btn" data-rating="5">5⭐</button>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="feedbackNotes" class="form-label small">Additional Notes (optional)</label>
            <textarea class="form-control" id="feedbackNotes" rows="2" placeholder="Any comments about the estimation..."></textarea>
          </div>
          
          <button type="button" class="btn btn-primary" id="submitFeedback">
            Submit Feedback
          </button>
        </div>
        
        <div id="feedbackSuccess" class="d-none">
          <div class="alert alert-success mb-0">
            <strong>Thank you!</strong> Your feedback has been submitted successfully.
          </div>
        </div>
        
        <div id="feedbackError" class="d-none">
          <div class="alert alert-danger mb-0">
            <span id="feedbackErrorText"></span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Disclaimer Card -->
    <div class="card mt-4 fade-in" style="animation-delay: 0.1s; background: linear-gradient(135deg, rgba(251, 191, 36, 0.05) 0%, rgba(251, 146, 60, 0.05) 100%); border-left: 4px solid #fbbf24;">
      <div class="card-body p-3">
        <div class="d-flex align-items-start gap-3">
          <div class="d-flex align-items-center justify-content-center flex-shrink-0" style="width: 36px; height: 36px; background: linear-gradient(135deg, #fbbf24 0%, #fb923c 100%); border-radius: 8px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
              <line x1="12" y1="9" x2="12" y2="13"></line>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
          </div>
          <div>
            <h4 class="h6 fw-bold mb-1">Important Note</h4>
            <p class="small text-muted mb-0">This is an AI-generated estimate and may not be accurate. Do not use for shipping, legal, or certified measurement purposes.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'frontend/js/weight_comparisons.js' %}"></script>
<script src="{% static 'frontend/js/result.js' %}"></script>
<script>
// Animate confidence meter on load
document.addEventListener('DOMContentLoaded', function() {
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.target.id === 'estConfidence' && mutation.target.textContent !== '--') {
        const confidence = mutation.target.textContent;
        const match = confidence.match(/(\d+)/);
        if (match) {
          const percent = parseInt(match[1]);
          document.getElementById('confidenceFill').style.width = percent + '%';
        }
      }
    });
  });
  
  const target = document.getElementById('estConfidence');
  if (target) {
    observer.observe(target, { childList: true, characterData: true, subtree: true });
  }
});
</script>
{% endblock %}
